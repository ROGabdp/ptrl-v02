#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
================================================================================
US Tech Stock Buy Agent - æ±ºç­–è¡¨ç¾è©•ä¼°è…³æœ¬
================================================================================
æ¸¬è©¦å°è±¡: NVDA, MSFT, AAPL, AMZN, META, AVGO, GOOGL, TSLA, NFLX, PLTR
æ¸¬è©¦æœŸé–“: 2017-10-16 ~ 2023-10-15 (VAL_RANGE)

æ ¸å¿ƒç›®çš„:
- é‡åŒ– Agent çš„é æ¸¬èƒ½åŠ›
- èˆ‡å¸‚å ´çœŸå¯¦èµ·æ¼²é»é »ç‡é€²è¡Œå°æ¯”

è¼¸å‡º:
- test_results_summary.csv: å„è‚¡çµ±è¨ˆæŒ‡æ¨™
- test_results_chart.png: æ±ºç­–æˆåŠŸç‡ vs å¸‚å ´çœŸå¯¦é »ç‡å°æ¯”åœ–

ä½œè€…ï¼šPhil Liang (Generated by Gemini)
æ—¥æœŸï¼š2026-01-18
================================================================================
"""

import os
import sys
import json
import torch
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime
from tqdm import tqdm

# Windows çµ‚ç«¯æ©Ÿ UTF-8 ç·¨ç¢¼è¨­å®š
if sys.platform == 'win32':
    sys.stdout.reconfigure(encoding='utf-8')

# è¨­å®šä¸­æ–‡å­—å‹
plt.rcParams['font.sans-serif'] = ['Microsoft JhengHei', 'SimHei', 'Arial Unicode MS']
plt.rcParams['axes.unicode_minus'] = False

# å°å…¥è¨“ç·´è…³æœ¬ä¸­çš„å‡½æ•¸
from train_us_tech_buy_agent import (
    load_or_update_local_csv,
    calculate_features,
    TICKERS, BENCHMARK, FEATURE_COLS, VAL_RANGE, MODELS_PATH
)

from stable_baselines3 import PPO


# =============================================================================
# å¸¸é‡å®šç¾©
# =============================================================================
VAL_START, VAL_END = VAL_RANGE
OUTPUT_DIR = "test_results"


# =============================================================================
# æ¨¡å‹è¼‰å…¥
# =============================================================================
def load_model_manifest(models_path: str) -> dict:
    """è¼‰å…¥ model_manifest.json"""
    manifest_path = os.path.join(models_path, "model_manifest.json")
    
    if not os.path.exists(manifest_path):
        print(f"âŒ æ‰¾ä¸åˆ° model_manifest.json: {manifest_path}")
        return None
    
    with open(manifest_path, 'r', encoding='utf-8') as f:
        return json.load(f)


def load_ticker_model(ticker: str, manifest: dict) -> PPO:
    """è¼‰å…¥æŒ‡å®š Ticker çš„æ¨¡å‹"""
    if ticker not in manifest.get("tickers", {}):
        print(f"  âš ï¸ {ticker} ä¸åœ¨ manifest ä¸­")
        return None
    
    model_path = manifest["tickers"][ticker]["model_path"]
    
    if not os.path.exists(model_path):
        print(f"  âš ï¸ {ticker} æ¨¡å‹æª”æ¡ˆä¸å­˜åœ¨: {model_path}")
        return None
    
    try:
        model = PPO.load(model_path, device="cpu")
        return model
    except Exception as e:
        print(f"  âŒ {ticker} æ¨¡å‹è¼‰å…¥å¤±æ•—: {e}")
        return None


# =============================================================================
# æ±ºç­–è©•ä¼°
# =============================================================================
def get_action_confidence(model: PPO, obs: np.ndarray) -> tuple:
    """
    å–å¾—æ¨¡å‹çš„å‹•ä½œèˆ‡ä¿¡å¿ƒåº¦
    
    Args:
        model: PPO æ¨¡å‹
        obs: è§€å¯Ÿå€¼ (ç‰¹å¾µå‘é‡)
    
    Returns:
        tuple: (action, buy_confidence)
            - action: 0 (WAIT) æˆ– 1 (BUY)
            - buy_confidence: è²·å…¥å‹•ä½œçš„æ©Ÿç‡å€¼
    """
    obs_tensor = torch.as_tensor(obs.reshape(1, -1), dtype=torch.float32)
    
    with torch.no_grad():
        # å–å¾—å‹•ä½œåˆ†ä½ˆ
        distribution = model.policy.get_distribution(obs_tensor)
        probs = distribution.distribution.probs.numpy()[0]
        
        # å–å¾—å‹•ä½œ
        action, _ = model.predict(obs, deterministic=True)
        action = int(action)
        
        # Buy ä¿¡å¿ƒåº¦ (Action 1 çš„æ©Ÿç‡)
        buy_confidence = float(probs[1])
    
    return action, buy_confidence


def evaluate_ticker(ticker: str, model: PPO, features_df: pd.DataFrame) -> dict:
    """
    è©•ä¼°å–®ä¸€è‚¡ç¥¨çš„ Agent è¡¨ç¾
    
    Args:
        ticker: è‚¡ç¥¨ä»£ç¢¼
        model: PPO æ¨¡å‹
        features_df: åŒ…å«ç‰¹å¾µèˆ‡ç›®æ¨™çš„ DataFrame
    
    Returns:
        dict: è©•ä¼°çµæœ
    """
    # éæ¿¾æ¸¬è©¦æœŸé–“
    test_df = features_df[
        (features_df.index >= pd.Timestamp(VAL_START)) &
        (features_df.index <= pd.Timestamp(VAL_END))
    ].copy()
    
    if len(test_df) == 0:
        print(f"  âš ï¸ {ticker} åœ¨æ¸¬è©¦æœŸé–“ç„¡è³‡æ–™")
        return None
    
    # ç¢ºä¿ Next_20d_Max å­˜åœ¨
    test_df = test_df.dropna(subset=['Next_20d_Max'])
    
    if len(test_df) == 0:
        print(f"  âš ï¸ {ticker} ç„¡æœ‰æ•ˆç›®æ¨™æ¨™ç±¤")
        return None
    
    print(f"  æ¸¬è©¦æœŸé–“: {test_df.index[0].date()} ~ {test_df.index[-1].date()} ({len(test_df)} å¤©)")
    
    # æ±ºç­–è¨˜éŒ„
    decisions = []
    
    for idx in tqdm(range(len(test_df)), desc=f"  Evaluating {ticker}", leave=False):
        row = test_df.iloc[idx]
        date = test_df.index[idx]
        
        # å–å¾—ç‰¹å¾µ
        obs = row[FEATURE_COLS].values.astype(np.float32)
        
        # å–å¾—å‹•ä½œèˆ‡ä¿¡å¿ƒåº¦
        action, buy_confidence = get_action_confidence(model, obs)
        
        # çœŸå¯¦æ¨™ç±¤
        next_20d_max = row['Next_20d_Max']
        is_rising_point = next_20d_max >= 0.10  # å¸‚å ´çœŸå¯¦èµ·æ¼²é»
        
        decisions.append({
            'date': date,
            'action': action,
            'buy_confidence': buy_confidence,
            'next_20d_max': next_20d_max,
            'is_rising_point': is_rising_point,
            'is_buy': action == 1,
            'is_success': (action == 1) and is_rising_point  # True Positive
        })
    
    decisions_df = pd.DataFrame(decisions)
    
    # è¨ˆç®—çµ±è¨ˆæŒ‡æ¨™
    total_days = len(decisions_df)
    rising_days = decisions_df['is_rising_point'].sum()
    trigger_count = decisions_df['is_buy'].sum()
    success_count = decisions_df['is_success'].sum()
    
    # å¹³å‡ä¿¡å¿ƒåº¦ (åƒ…è¨ˆç®—è²·å…¥æ±ºç­–)
    buy_decisions = decisions_df[decisions_df['is_buy']]
    avg_confidence = buy_decisions['buy_confidence'].mean() if len(buy_decisions) > 0 else 0.0
    
    # Precision & Recall
    precision = success_count / trigger_count if trigger_count > 0 else 0.0
    recall = success_count / rising_days if rising_days > 0 else 0.0
    
    # å¸‚å ´çœŸå¯¦é »ç‡
    market_rate = rising_days / total_days if total_days > 0 else 0.0
    
    result = {
        'ticker': ticker,
        'total_days': total_days,
        'rising_days': rising_days,
        'market_rate': market_rate,
        'trigger_count': trigger_count,
        'success_count': success_count,
        'avg_confidence': avg_confidence,
        'precision': precision,
        'recall': recall,
        'decisions_df': decisions_df
    }
    
    return result


# =============================================================================
# çµæœè¼¸å‡º
# =============================================================================
def save_summary_csv(results: list, output_dir: str):
    """å„²å­˜å½™ç¸½ CSV"""
    summary_data = []
    
    for r in results:
        if r is None:
            continue
        summary_data.append({
            'Ticker': r['ticker'],
            'ç¸½å¤©æ•¸': r['total_days'],
            'èµ·æ¼²å¤©æ•¸': r['rising_days'],
            'å¸‚å ´èµ·æ¼²é »ç‡': f"{r['market_rate']:.1%}",
            'Agentè§¸ç™¼æ¬¡æ•¸': r['trigger_count'],
            'æˆåŠŸæ¬¡æ•¸': r['success_count'],
            'å¹³å‡ä¿¡å¿ƒåº¦': f"{r['avg_confidence']:.3f}",
            'æ±ºç­–æˆåŠŸç‡(Precision)': f"{r['precision']:.1%}",
            'èµ·æ¼²é»æ•æ‰ç‡(Recall)': f"{r['recall']:.1%}"
        })
    
    summary_df = pd.DataFrame(summary_data)
    csv_path = os.path.join(output_dir, "test_results_summary.csv")
    summary_df.to_csv(csv_path, index=False, encoding='utf-8-sig')
    print(f"\nâœ… å½™ç¸½å ±è¡¨å·²å„²å­˜: {csv_path}")
    
    return summary_df


def plot_comparison_chart(results: list, output_dir: str):
    """ç¹ªè£½æ±ºç­–æˆåŠŸç‡ vs å¸‚å ´çœŸå¯¦é »ç‡å°æ¯”åœ–"""
    valid_results = [r for r in results if r is not None]
    
    if len(valid_results) == 0:
        print("âš ï¸ ç„¡æœ‰æ•ˆçµæœå¯ç¹ªåœ–")
        return
    
    tickers = [r['ticker'] for r in valid_results]
    precisions = [r['precision'] * 100 for r in valid_results]
    market_rates = [r['market_rate'] * 100 for r in valid_results]
    recalls = [r['recall'] * 100 for r in valid_results]
    
    x = np.arange(len(tickers))
    width = 0.25
    
    fig, ax = plt.subplots(figsize=(14, 7))
    
    bars1 = ax.bar(x - width, market_rates, width, label='å¸‚å ´èµ·æ¼²é »ç‡', color='#2196F3', alpha=0.8)
    bars2 = ax.bar(x, precisions, width, label='æ±ºç­–æˆåŠŸç‡ (Precision)', color='#4CAF50', alpha=0.8)
    bars3 = ax.bar(x + width, recalls, width, label='æ•æ‰ç‡ (Recall)', color='#FF9800', alpha=0.8)
    
    ax.set_ylabel('ç™¾åˆ†æ¯” (%)', fontsize=12)
    ax.set_xlabel('è‚¡ç¥¨ä»£ç¢¼', fontsize=12)
    ax.set_title(f'US Tech Stock Buy Agent æ±ºç­–è¡¨ç¾è©•ä¼°\næ¸¬è©¦æœŸé–“: {VAL_START} ~ {VAL_END}', fontsize=14)
    ax.set_xticks(x)
    ax.set_xticklabels(tickers, fontsize=11)
    ax.legend(loc='upper right', fontsize=10)
    ax.set_ylim(0, 100)
    ax.grid(axis='y', alpha=0.3)
    
    # æ·»åŠ æ•¸å€¼æ¨™ç±¤
    def add_labels(bars):
        for bar in bars:
            height = bar.get_height()
            ax.annotate(f'{height:.1f}',
                        xy=(bar.get_x() + bar.get_width() / 2, height),
                        xytext=(0, 3),
                        textcoords="offset points",
                        ha='center', va='bottom', fontsize=8)
    
    add_labels(bars1)
    add_labels(bars2)
    add_labels(bars3)
    
    plt.tight_layout()
    
    chart_path = os.path.join(output_dir, "test_results_chart.png")
    plt.savefig(chart_path, dpi=150, bbox_inches='tight')
    plt.close()
    
    print(f"âœ… å°æ¯”åœ–è¡¨å·²å„²å­˜: {chart_path}")


def print_summary_table(results: list):
    """å°å‡ºæ‘˜è¦è¡¨æ ¼"""
    print("\n" + "=" * 90)
    print("ğŸ“Š Buy Agent æ±ºç­–è¡¨ç¾è©•ä¼°çµæœ")
    print(f"   æ¸¬è©¦æœŸé–“: {VAL_START} ~ {VAL_END}")
    print("=" * 90)
    
    print(f"\n{'Ticker':>8} | {'ç¸½å¤©æ•¸':>6} | {'èµ·æ¼²å¤©æ•¸':>8} | {'å¸‚å ´é »ç‡':>8} | {'è§¸ç™¼æ¬¡æ•¸':>8} | {'æˆåŠŸæ¬¡æ•¸':>8} | {'Precision':>10} | {'Recall':>8}")
    print("-" * 90)
    
    total_rising = 0
    total_trigger = 0
    total_success = 0
    
    for r in results:
        if r is None:
            continue
        print(f"{r['ticker']:>8} | {r['total_days']:>6} | {r['rising_days']:>8} | {r['market_rate']:>7.1%} | {r['trigger_count']:>8} | {r['success_count']:>8} | {r['precision']:>9.1%} | {r['recall']:>7.1%}")
        total_rising += r['rising_days']
        total_trigger += r['trigger_count']
        total_success += r['success_count']
    
    print("-" * 90)
    
    # ç¸½è¨ˆ
    overall_precision = total_success / total_trigger if total_trigger > 0 else 0
    overall_recall = total_success / total_rising if total_rising > 0 else 0
    
    print(f"{'ç¸½è¨ˆ':>8} | {'':>6} | {total_rising:>8} | {'':>8} | {total_trigger:>8} | {total_success:>8} | {overall_precision:>9.1%} | {overall_recall:>7.1%}")
    print("=" * 90)


# =============================================================================
# ä¸»ç¨‹å¼
# =============================================================================
def main():
    print("=" * 70)
    print("  US Tech Stock Buy Agent - æ±ºç­–è¡¨ç¾è©•ä¼°")
    print(f"  æ¸¬è©¦æœŸé–“: {VAL_START} ~ {VAL_END}")
    print("=" * 70)
    
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    
    # =========================================================================
    # Step 1: è¼‰å…¥ Model Manifest
    # =========================================================================
    print("\n[Step 1] è¼‰å…¥ Model Manifest...")
    manifest = load_model_manifest(MODELS_PATH)
    
    if manifest is None:
        print("âŒ ç„¡æ³•è¼‰å…¥ manifestï¼Œçµ‚æ­¢æ¸¬è©¦")
        return
    
    print(f"  âœ… å·²è¼‰å…¥ {len(manifest['tickers'])} å€‹æ¨¡å‹è³‡è¨Š")
    
    # =========================================================================
    # Step 2: è¼‰å…¥åŸºæº–æŒ‡æ•¸
    # =========================================================================
    print("\n[Step 2] è¼‰å…¥åŸºæº–æŒ‡æ•¸...")
    benchmark_df = load_or_update_local_csv(BENCHMARK)
    
    if benchmark_df is None:
        print("âŒ ç„¡æ³•è¼‰å…¥åŸºæº–æŒ‡æ•¸ï¼Œçµ‚æ­¢æ¸¬è©¦")
        return
    
    # =========================================================================
    # Step 3: é€è‚¡è©•ä¼°
    # =========================================================================
    print("\n[Step 3] é€è‚¡è©•ä¼°...")
    results = []
    
    for ticker in TICKERS:
        print(f"\nğŸ“ˆ {ticker}")
        print("-" * 40)
        
        # è¼‰å…¥æ¨¡å‹
        model = load_ticker_model(ticker, manifest)
        if model is None:
            results.append(None)
            continue
        print(f"  âœ… æ¨¡å‹è¼‰å…¥æˆåŠŸ")
        
        # è¼‰å…¥è³‡æ–™
        raw_df = load_or_update_local_csv(ticker)
        if raw_df is None:
            print(f"  âš ï¸ {ticker} è³‡æ–™è¼‰å…¥å¤±æ•—")
            results.append(None)
            continue
        
        # è¨ˆç®—ç‰¹å¾µ (ä½¿ç”¨å¿«å–)
        features_df = calculate_features(raw_df, benchmark_df, ticker, use_cache=True)
        
        # è©•ä¼°
        result = evaluate_ticker(ticker, model, features_df)
        results.append(result)
        
        if result:
            print(f"  ğŸ“Š Precision: {result['precision']:.1%} | Recall: {result['recall']:.1%} | ä¿¡å¿ƒåº¦: {result['avg_confidence']:.3f}")
    
    # =========================================================================
    # Step 4: è¼¸å‡ºçµæœ
    # =========================================================================
    print("\n[Step 4] è¼¸å‡ºçµæœ...")
    
    # å°å‡ºæ‘˜è¦è¡¨æ ¼
    print_summary_table(results)
    
    # å„²å­˜ CSV
    save_summary_csv(results, OUTPUT_DIR)
    
    # ç¹ªè£½å°æ¯”åœ–
    plot_comparison_chart(results, OUTPUT_DIR)
    
    print("\n" + "=" * 70)
    print("  âœ… è©•ä¼°å®Œæˆï¼")
    print(f"  ğŸ“ çµæœå„²å­˜æ–¼: {OUTPUT_DIR}/")
    print("=" * 70)


if __name__ == "__main__":
    main()
